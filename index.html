<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—è –§–µ—Ä–º–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase/Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase
        window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        window.app = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug'); // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        window.setupFirebase = async () => {
            try {
                if (window.initialAuthToken) {
                    await signInWithCustomToken(window.auth, window.initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Authenticated as:", window.userId);
                        window.loadGameData();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ö–æ—Ç—è –∞–Ω–æ–Ω–∏–º–Ω–∞—è –¥–æ–ª–∂–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
                        window.userId = crypto.randomUUID();
                        console.log("Using temporary ID:", window.userId);
                        window.loadGameData();
                    }
                });
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        };

        window.loadGameData = () => {
            // –ü—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: /artifacts/{appId}/users/{userId}/game_data/main_data
            const userDocPath = `artifacts/${window.appId}/users/${window.userId}/game_data`;
            const mainDocRef = doc(window.db, userDocPath, 'main_data');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            onSnapshot(mainDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.gameState.money = data.money || 0;
                    window.gameState.inventory = data.inventory || {};
                    console.log("Game data loaded/updated:", window.gameState);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    console.log("No data found. Creating initial data.");
                    window.gameState.money = 100; // –ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
                    window.gameState.inventory = { '–Ø–π—Ü–æ': 0 };
                    // setDoc —Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    setDoc(mainDocRef, window.gameState).catch(err => console.error("Error creating initial data:", err));
                }
                window.updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
            });
        };

        window.saveGameData = async () => {
            const userDocPath = `artifacts/${window.appId}/users/${window.userId}/game_data`;
            const mainDocRef = doc(window.db, userDocPath, 'main_data');
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—è money –∏ inventory
                await updateDoc(mainDocRef, {
                    money: window.gameState.money,
                    inventory: window.gameState.inventory
                });
                console.log("Game data saved successfully.");
            } catch (error) {
                console.error("Error saving game data:", error);
            }
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–∫–Ω–∞
        window.addEventListener('load', window.setupFirebase);
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3e8; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ—Ç—Å—Ç—É–ø—ã —É–¥–∞–ª–µ–Ω—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ */
            padding: 0;
            margin: 0;
        }
        .game-container {
            /* –í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (max-width, margin, border, radius, shadow) —É–¥–∞–ª–µ–Ω—ã */
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* –ë–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
            overflow: hidden;
        }
        .tab-button {
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            /* –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ border-top, —Ç.–∫. –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–Ω–∏–∑—É */
            border-top: 4px solid transparent; 
        }
        .tab-button:hover:not(.active) {
            background-color: #f5f5f5;
        }
        .tab-button.active {
            background-color: #fff;
            color: #d97706; /* Amber color */
            /* –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ border-top */
            border-top: 4px solid #d97706;
            font-weight: 700;
        }
        .item-card {
            background-color: #fffbe6; /* Light yellow background */
            border: 2px solid #fbbf24;
            transition: transform 0.1s;
        }
        .buy-button {
            background-color: #10b981; /* Emerald green */
            transition: background-color 0.15s, transform 0.1s;
        }
        .buy-button:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .buy-button:disabled {
            background-color: #d1d5db; /* Gray out when disabled */
            cursor: not-allowed;
        }
    </style>
</head>
<!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º body –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –∏ —Å–∫—Ä—ã–≤–∞–µ–º overflow -->
<body class="h-screen w-screen overflow-hidden">

    <!-- –¢–µ–ø–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å body -->
    <div id="app" class="game-container h-full flex flex-col">
        <!-- HEADER: –î–µ–Ω—å–≥–∏ –∏ ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å, –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è) -->
        <header class="p-4 bg-yellow-600 text-white flex justify-between items-center shadow-lg flex-shrink-0">
            <h1 class="text-2xl font-bold">–ú–æ—è –§–µ—Ä–º–∞</h1>
            <div class="text-right">
                <div id="money-display" class="text-xl font-bold bg-yellow-800 p-1 px-3 rounded-full shadow-inner">
                    –î–µ–Ω—å–≥–∏: 0 üí∞
                </div>
                <div class="text-xs mt-1 opacity-75">
                    ID: <span id="user-id-display">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
        </header>

        <!-- –û–°–ù–û–í–ù–û–ï –°–û–î–ï–†–ñ–ê–ù–ò–ï (–ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è) -->
        <main id="tab-content" class="p-6 overflow-y-auto flex-grow">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </main>

        <!-- –ò–ù–í–ï–ù–¢–ê–†–¨ (–ü–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º, –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è) -->
        <section class="p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0">
            <h2 class="text-lg font-bold text-gray-700 mb-2">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
            <div id="inventory-display" class="flex flex-wrap gap-2">
                <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                <p class="text-gray-500 italic">–ü—É—Å—Ç–æ</p>
            </div>
        </section>
        
        <!-- –¢–ê–ë–´ (–ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø) -->
        <nav class="flex justify-around bg-gray-100 border-t border-gray-300 flex-shrink-0">
            <button id="tab-farm" class="tab-button active p-3 w-1/3 text-gray-700" onclick="switchTab('farm')">
                –§–µ—Ä–º–∞
            </button>
            <button id="tab-shop" class="tab-button p-3 w-1/3 text-gray-700" onclick="switchTab('shop')">
                –ú–∞–≥–∞–∑–∏–Ω
            </button>
            <button id="tab-settings" class="tab-button p-3 w-1/3 text-gray-700" onclick="switchTab('settings')">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </nav>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ alert/confirm) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full border-4 border-yellow-500">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-yellow-700"></h3>
            <p id="modal-message" class="mb-4"></p>
            <button onclick="closeModal()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg transition">
                –û–ö
            </button>
        </div>
    </div>

    <script>
        // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å Firebase)
        window.gameState = {
            money: 0,
            inventory: {},
            currentTab: 'farm'
        };

        const SHOP_ITEMS = [
            { id: 'egg', name: '–Ø–π—Ü–æ', price: 40, emoji: 'ü•ö', description: '–û—Å–Ω–æ–≤–∞ –ª—é–±–æ–π —Ñ–µ—Ä–º—ã. –ù—É–∂–Ω–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞.' }
        ];

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI ---

        function openModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        function switchTab(tabName) {
            window.gameState.currentTab = tabName;
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            updateContent();
        }

        function updateContent() {
            const contentDiv = document.getElementById('tab-content');
            contentDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

            switch (window.gameState.currentTab) {
                case 'farm':
                    contentDiv.innerHTML = renderFarmTab();
                    break;
                case 'shop':
                    contentDiv.innerHTML = renderShopTab();
                    break;
                case 'settings':
                    contentDiv.innerHTML = renderSettingsTab();
                    break;
            }
        }

        function updateUI() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–Ω–µ–≥
            document.getElementById('money-display').textContent = `–î–µ–Ω—å–≥–∏: ${window.gameState.money} üí∞`;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('user-id-display').textContent = window.userId ? window.userId : 'N/A';

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            const inventoryDiv = document.getElementById('inventory-display');
            inventoryDiv.innerHTML = '';

            const items = window.gameState.inventory;
            const itemKeys = Object.keys(items);

            if (itemKeys.length === 0 || itemKeys.every(key => items[key] === 0)) {
                inventoryDiv.innerHTML = '<p class="text-gray-500 italic">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç. –ö—É–ø–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ!</p>';
            } else {
                itemKeys.forEach(itemName => {
                    const quantity = items[itemName];
                    if (quantity > 0) {
                        const itemElement = document.createElement('span');
                        itemElement.className = 'bg-yellow-200 text-yellow-900 px-3 py-1 rounded-full text-sm font-semibold shadow';
                        // –ò—â–µ–º —ç–º–æ–¥–∑–∏ –ø–æ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
                        const itemData = SHOP_ITEMS.find(item => item.name === itemName);
                        const emoji = itemData ? itemData.emoji : 'üì¶';
                        itemElement.textContent = `${emoji} ${itemName}: ${quantity}`;
                        inventoryDiv.appendChild(itemElement);
                    }
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–µ—Å–ª–∏ –æ–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è)
            updateContent();
        }

        // --- –õ–æ–≥–∏–∫–∞ –≤–∫–ª–∞–¥–æ–∫ ---

        function renderFarmTab() {
            return `
                <div class="text-center p-8 bg-green-50 rounded-lg border-2 border-green-300">
                    <h2 class="text-3xl font-bold text-green-700 mb-4">üè† –§–µ—Ä–º–∞</h2>
                    <p class="text-gray-600">–í–∞—à–∞ —Ñ–µ—Ä–º–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –ö—É–ø–∏—Ç–µ —è–π—Ü–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã!</p>
                    <p class="mt-4 text-sm text-gray-500">–ó–¥–µ—Å—å –≤ –±—É–¥—É—â–µ–º –ø–æ—è–≤—è—Ç—Å—è –≤–∞—à–∏ –∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø–æ—Å—Ç—Ä–æ–π–∫–∏.</p>
                </div>
            `;
        }

        function renderShopTab() {
            let html = `
                <h2 class="text-3xl font-bold text-yellow-700 mb-4">üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
                <div class="space-y-4">
            `;

            SHOP_ITEMS.forEach(item => {
                const canAfford = window.gameState.money >= item.price;
                html += `
                    <div class="item-card p-4 rounded-xl shadow-md flex justify-between items-center">
                        <div>
                            <p class="text-xl font-bold text-yellow-800">${item.emoji} ${item.name}</p>
                            <p class="text-sm text-gray-600">${item.description}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold text-red-600 mb-2">–¶–µ–Ω–∞: ${item.price} üí∞</p>
                            <button
                                onclick="buyItem('${item.name}', ${item.price})"
                                ${canAfford ? '' : 'disabled'}
                                class="buy-button text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:opacity-50"
                            >
                                ${canAfford ? '–ö—É–ø–∏—Ç—å' : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç'}
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            return html;
        }

        function renderSettingsTab() {
            return `
                <div class="text-center p-8 bg-blue-50 rounded-lg border-2 border-blue-300">
                    <h2 class="text-3xl font-bold text-blue-700 mb-4">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                    <p class="text-gray-600">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ–ø—Ü–∏–∏ –∏–≥—Ä—ã.</p>
                    <p class="mt-4 text-sm text-gray-500">–ù–∞–ø—Ä–∏–º–µ—Ä, —Å–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–≤—É–∫–æ–≤.</p>
                </div>
            `;
        }


        // --- –õ–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏ ---

        function buyItem(itemName, price) {
            if (window.gameState.money >= price) {
                // 1. –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏
                window.gameState.money -= price;

                // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
                if (window.gameState.inventory[itemName]) {
                    window.gameState.inventory[itemName] += 1;
                } else {
                    window.gameState.inventory[itemName] = 1;
                }

                // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º UI
                window.saveGameData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firestore
                openModal("–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!", `–í—ã –∫—É–ø–∏–ª–∏ 1 ${itemName} –∑–∞ ${price} üí∞.`);

            } else {
                openModal("–û—à–∏–±–∫–∞", `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ ${itemName}. –í–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${price - window.gameState.money} üí∞.`);
            }
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        switchTab(window.gameState.currentTab);
    </script>
</body>
</html>
