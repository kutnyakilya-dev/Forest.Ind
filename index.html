<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Multiplayer World</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            color: white;
        }
        canvas {
            display: block;
        }
        #ui-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #fullscreen-btn {
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        #player-id-display {
            padding: 10px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 8px;
            font-size: 12px;
            word-break: break-all;
        }
        /* Стили для мобильного управления */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: none; /* Скрыто по умолчанию, будет показано через JS на мобильных */
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 100;
            user-select: none; /* Отключить выделение текста при нажатии */
        }
        .control-cluster {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .control-btn {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <button id="fullscreen-btn">Во весь экран</button>
        <div id="player-id-display">Загрузка...</div>
    </div>
    
    <!-- Элементы управления для мобильных устройств -->
    <div id="mobile-controls">
        <div class="control-cluster">
            <div id="turn-left" class="control-btn">⟲</div>
            <div id="turn-right" class="control-btn">⟳</div>
        </div>
        <div class="control-cluster">
            <div id="move-forward" class="control-btn">▲</div>
            <div id="move-backward" class="control-btn">▼</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        // --- Библиотеки ---
        import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, setDoc, doc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- Конфигурация Firebase ---
        // Используем предоставленную конфигурацию
        const firebaseConfig = {
            apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
            authDomain: "my-pet-c8684.firebaseapp.com",
            projectId: "my-pet-c8684",
            storageBucket: "my-pet-c8684.firebasestorage.app",
            messagingSenderId: "102742166711",
            appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Глобальные переменные ---
        let scene, camera, renderer, clock;
        let localPlayer, localPlayerId;
        const players = {}; // Хранилище для объектов других игроков
        const movement = { forward: 0, turn: 0 };
        const speed = 5;
        const turnSpeed = Math.PI / 2;
        const MAP_SIZE = 100;
        
        // --- Инициализация ---
        function init() {
            // Сцена
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 0, MAP_SIZE * 0.75);
            clock = new THREE.Clock();

            // Камера
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 20);
            camera.lookAt(0, 0, 0);

            // Рендерер
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;

            // Освещение
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(-30, 50, -30);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // Создание карты
            createMap();
            
            // Настройка управления и событий
            setupControls();
            window.addEventListener('resize', onWindowResize);
            
            // Запуск Firebase
            setupFirebase();

            // Запуск игрового цикла
            animate();
        }

        // --- Создание игрового мира ---
        function createMap() {
            // Земля
            const groundGeometry = new THREE.PlaneGeometry(MAP_SIZE, MAP_SIZE);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x228b22 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Деревья
            const treeCount = 150;
            for (let i = 0; i < treeCount; i++) {
                createTree(
                    (Math.random() - 0.5) * MAP_SIZE,
                    (Math.random() - 0.5) * MAP_SIZE
                );
            }
        }

        function createTree(x, z) {
            const trunkHeight = Math.random() * 4 + 2;
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.4, trunkHeight, 8);
            const trunkMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.set(x, trunkHeight / 2, z);
            trunk.castShadow = true;
            
            const leavesHeight = Math.random() * 3 + 3;
            const leavesGeo = new THREE.ConeGeometry(2, leavesHeight, 8);
            const leavesMat = new THREE.MeshLambertMaterial({ color: 0x006400 });
            const leaves = new THREE.Mesh(leavesGeo, leavesMat);
            leaves.position.set(x, trunkHeight + leavesHeight / 2, z);
            leaves.castShadow = true;

            scene.add(trunk);
            scene.add(leaves);
        }

        // --- Игрок ---
        function createPlayer(id, isLocal = false) {
            const playerGeo = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
            // Генерируем цвет на основе ID для консистентности
            const color = new THREE.Color('#' + id.substring(0, 6)); 
            const playerMat = new THREE.MeshStandardMaterial({ color });
            const playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.castShadow = true;
            playerMesh.position.y = 1;
            
            const playerContainer = new THREE.Object3D();
            playerContainer.add(playerMesh);

            if (isLocal) {
                // Размещаем локального игрока в случайном месте
                playerContainer.position.set(
                    (Math.random() - 0.5) * 20,
                    0,
                    (Math.random() - 0.5) * 20
                );
                // Добавляем камеру к контейнеру игрока
                playerContainer.add(camera);
                camera.position.set(0, 5, 8); // Позиция камеры относительно игрока
                // Заставляем камеру смотреть на центр игрока (в локальных координатах контейнера)
                camera.lookAt(0, 1, 0);
            }
            
            scene.add(playerContainer);
            return playerContainer;
        }

        // --- Firebase ---
        function setupFirebase() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    localPlayerId = user.uid;
                    document.getElementById('player-id-display').textContent = `Ваш ID: ${localPlayerId}`;

                    localPlayer = createPlayer(localPlayerId, true);
                    updatePlayerPositionInFirestore();

                    // Подписка на изменения в коллекции игроков
                    const playersCollection = collection(db, "players");
                    onSnapshot(playersCollection, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            const playerData = change.doc.data();
                            const playerId = change.doc.id;

                            if (playerId === localPlayerId) return;

                            if (change.type === "added" || change.type === "modified") {
                                if (players[playerId]) {
                                    // Обновляем позицию существующего игрока
                                    players[playerId].position.set(playerData.x, playerData.y, playerData.z);
                                    players[playerId].rotation.y = playerData.ry;
                                } else {
                                    // Добавляем нового игрока
                                    players[playerId] = createPlayer(playerId);
                                    players[playerId].position.set(playerData.x, playerData.y, playerData.z);
                                    players[playerId].rotation.y = playerData.ry;
                                }
                            } else if (change.type === "removed") {
                                if (players[playerId]) {
                                    scene.remove(players[playerId]);
                                    delete players[playerId];
                                }
                            }
                        });
                    });

                    // Удаление игрока при закрытии вкладки
                    window.addEventListener('beforeunload', () => {
                        deleteDoc(doc(db, "players", localPlayerId));
                    });

                } else {
                   signInAnonymously(auth).catch(error => console.error("Ошибка анонимного входа:", error));
                }
            });
        }
        
        async function updatePlayerPositionInFirestore() {
            if (!localPlayerId || !localPlayer) return;
            try {
                const playerDocRef = doc(db, "players", localPlayerId);
                await setDoc(playerDocRef, {
                    x: localPlayer.position.x,
                    y: localPlayer.position.y,
                    z: localPlayer.position.z,
                    ry: localPlayer.rotation.y, // rotation y
                    timestamp: Date.now()
                }, { merge: true });
            } catch (error) {
                console.error("Ошибка обновления данных в Firestore:", error);
            }
        }

        // --- Управление ---
        function setupControls() {
            // Определение типа устройства
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                document.getElementById('mobile-controls').style.display = 'flex';
                // Вперед
                document.getElementById('move-forward').addEventListener('touchstart', () => movement.forward = 1);
                document.getElementById('move-forward').addEventListener('touchend', () => movement.forward = 0);
                // Назад
                document.getElementById('move-backward').addEventListener('touchstart', () => movement.forward = -1);
                document.getElementById('move-backward').addEventListener('touchend', () => movement.forward = 0);
                // Влево
                document.getElementById('turn-left').addEventListener('touchstart', () => movement.turn = 1);
                document.getElementById('turn-left').addEventListener('touchend', () => movement.turn = 0);
                // Вправо
                document.getElementById('turn-right').addEventListener('touchstart', () => movement.turn = -1);
                document.getElementById('turn-right').addEventListener('touchend', () => movement.turn = 0);
            } else {
                // Клавиатура
                document.addEventListener('keydown', (e) => {
                    switch(e.code) {
                        case 'KeyW': case 'ArrowUp': movement.forward = 1; break;
                        case 'KeyS': case 'ArrowDown': movement.forward = -1; break;
                        case 'KeyA': case 'ArrowLeft': movement.turn = 1; break;
                        case 'KeyD': case 'ArrowRight': movement.turn = -1; break;
                    }
                });
                document.addEventListener('keyup', (e) => {
                    switch(e.code) {
                        case 'KeyW': case 'ArrowUp': movement.forward = 0; break;
                        case 'KeyS': case 'ArrowDown': movement.forward = 0; break;
                        case 'KeyA': case 'ArrowLeft': movement.turn = 0; break;
                        case 'KeyD': case 'ArrowRight': movement.turn = 0; break;
                    }
                });
            }

            // Кнопка полного экрана
            document.getElementById('fullscreen-btn').addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen().catch(err => {
                        alert(`Не удалось войти в полноэкранный режим: ${err.message}`);
                    });
                }
            });
        }

        // --- Игровой цикл ---
        let lastUpdateTime = 0;
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (localPlayer) {
                const prevPosition = localPlayer.position.clone();
                const prevRotation = localPlayer.rotation.y;

                // Поворот
                localPlayer.rotation.y += movement.turn * turnSpeed * delta;
                
                // Движение
                if (movement.forward !== 0) {
                    localPlayer.translateZ(-movement.forward * speed * delta);
                }
                
                // Проверка, изменилась ли позиция
                if (!localPlayer.position.equals(prevPosition) || localPlayer.rotation.y !== prevRotation) {
                     // Отправляем данные в Firestore не чаще чем раз в 100 мс
                    const now = Date.now();
                    if (now - lastUpdateTime > 100) {
                        updatePlayerPositionInFirestore();
                        lastUpdateTime = now;
                    }
                }
            }
            
            renderer.render(scene, camera);
        }

        // --- Вспомогательные функции ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // --- Запуск ---
        init();
    </script>
</body>
</html>

