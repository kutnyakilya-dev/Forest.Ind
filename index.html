<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лесное Приключение (3D FPS)</title>
    <!-- Загрузка Three.js для 3D графики -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Загрузка PointerLockControls для управления от первого лица -->
    <script src="https://threejs.org/examples/js/controls/PointerLockControls.js"></script>
    <script type="module">
        // Импорт Firebase v9 модулей
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Глобальные переменные Firebase (REQUIRED) ---
        // Эти переменные должны быть объявлены в среде Canvas, но мы предоставляем запасные варианты.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Запасная конфигурация, предоставленная пользователем (Ильей) для GitHub Pages
        const fallbackFirebaseConfig = {
            apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
            authDomain: "my-pet-c8684.firebaseapp.com",
            projectId: "my-pet-c8684",
            storageBucket: "my-pet-c8684.firebasestorage.app",
            messagingSenderId: "102742166711",
            appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app;
        let db;
        let auth;
        let userId = null;
        let playerRef = null;
        
        let otherPlayers = {};
        const multiplayerReady = { value: false };

        /**
         * Устанавливает соединение с Firebase и аутентифицирует пользователя.
         * Использует onAuthStateChanged для надежного получения userId.
         */
        async function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Ожидание изменения состояния аутентификации
                return new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Отписка после первой проверки

                        if (user) {
                            userId = user.uid;
                            console.log("Firebase: Authenticated with UID:", userId);
                            resolve(true);
                        } else if (initialAuthToken) {
                            // Попытка входа через токен (для среды Canvas)
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Firebase: Token sign-in failed, trying anonymous.", error.code);
                                await signInAnonymously(auth);
                            }
                        } else {
                            // Запасной анонимный вход (для внешнего развертывания, как GitHub)
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Firebase: Anonymous sign-in failed. Check config and rules.", error);
                                showErrorMessage("Ошибка подключения к Firebase.", "Проверьте консоль на наличие ошибок аутентификации или правил безопасности Firestore.");
                                resolve(false);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Firebase setup failed:", error);
                showErrorMessage("Ошибка подключения к Firebase.", "Проверьте консоль на наличие ошибок аутентификации или правил безопасности Firestore.");
                return false;
            }
        }

        /**
         * Инициализирует многопользовательский режим после успешной аутентификации.
         */
        function startMultiplayer() {
            if (!userId) {
                console.error("Multiplayer cannot start: userId is null.");
                showErrorMessage("Ошибка: Не удалось подключиться к многопользовательскому режиму.", "Попробуйте перезагрузить страницу.");
                return;
            }

            // Путь к документу игрока: /artifacts/{appId}/public/data/players/{userId}
            const collectionPath = `artifacts/${appId}/public/data/players`;
            playerRef = doc(db, collectionPath, userId);
            
            // 1. Установка начального положения (публикация своего документа)
            setPlayerPosition(camera.position, camera.rotation.y);

            // 2. Слушатель для других игроков
            const playersCollection = collection(db, collectionPath);
            onSnapshot(playersCollection, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const otherUserId = change.doc.id;
                    
                    if (otherUserId === userId) return; // Пропускаем себя

                    if (change.type === "added" || change.type === "modified") {
                        handlePlayerUpdate(otherUserId, data);
                    } else if (change.type === "removed") {
                        handlePlayerRemoval(otherUserId);
                    }
                });
            });

            // 3. Установка функции очистки при закрытии
            window.addEventListener('beforeunload', cleanupPlayer);

            multiplayerReady.value = true;
            console.log("Multiplayer started. User ID:", userId);
        }

        /**
         * Обновляет позицию игрока в Firestore.
         * @param {THREE.Vector3} position - Позиция игрока.
         * @param {number} rotationY - Поворот игрока по Y.
         */
        function setPlayerPosition(position, rotationY) {
            if (!playerRef) return;
            
            setDoc(playerRef, {
                position: { x: position.x, y: position.y, z: position.z },
                rotationY: rotationY,
                userId: userId,
                lastSeen: serverTimestamp()
            }, { merge: true })
            .catch(error => {
                console.error("Error writing player position:", error);
            });
        }

        /**
         * Обрабатывает обновление данных другого игрока.
         * @param {string} id - ID другого игрока.
         * @param {object} data - Данные позиции.
         */
        function handlePlayerUpdate(id, data) {
            if (!otherPlayers[id]) {
                // Создание нового аватара
                const geometry = new THREE.SphereGeometry(1, 16, 16);
                const material = new THREE.MeshBasicMaterial({ color: Math.random() * 0xffffff });
                const avatar = new THREE.Mesh(geometry, material);
                avatar.name = `Player_${id}`;
                scene.add(avatar);
                otherPlayers[id] = avatar;
                console.log(`New player joined: ${id}`);

                // Добавление "никнейма"
                const usernameDiv = document.createElement('div');
                usernameDiv.className = 'username-tag';
                usernameDiv.textContent = id.substring(0, 8); // Показываем часть ID
                usernameDiv.style.color = `#${material.color.getHexString()}`;
                
                const tag = {
                    element: usernameDiv,
                    object: avatar // Привязываем элемент к 3D объекту
                };
                
                document.getElementById('tags-container').appendChild(usernameDiv);
                otherPlayers[id].tag = tag;
            }

            const avatar = otherPlayers[id];
            
            // Обновление позиции и поворота
            if (data.position) {
                avatar.position.set(data.position.x, data.position.y, data.position.z);
            }
            if (data.rotationY !== undefined) {
                avatar.rotation.y = data.rotationY;
            }
        }
        
        /**
         * Обрабатывает удаление другого игрока.
         * @param {string} id - ID удаленного игрока.
         */
        function handlePlayerRemoval(id) {
            if (otherPlayers[id]) {
                const avatar = otherPlayers[id];
                scene.remove(avatar);
                if (avatar.tag) {
                    document.getElementById('tags-container').removeChild(avatar.tag.element);
                }
                delete otherPlayers[id];
                console.log(`Player left: ${id}`);
            }
        }
        
        /**
         * Очищает документ игрока в Firestore при выходе.
         */
        function cleanupPlayer() {
            if (playerRef) {
                deleteDoc(playerRef)
                    .then(() => console.log("Player document removed successfully."))
                    .catch(error => console.error("Error removing player document:", error));
            }
        }
        
        // --- THREE.JS СЦЕНА И ЛОГИКА ИГРЫ ---
        
        let camera, scene, renderer, controls;
        let clock = new THREE.Clock();
        
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let canJump = false;
        
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        
        const forestSize = 100; // Размер леса (100x100)
        const treeCount = 100; // Количество деревьев
        const floorHeight = 0; // Уровень пола
        
        let raycaster;
        const collisionObjects = [];
        
        // --- Элементы UI ---
        const startScreen = document.getElementById('startScreen');
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');

        // --- Аудио ---
        const sound = {
            context: null,
            gainNode: null
        };
        
        // Инициализация аудиоконтекста (для обхода ограничений браузера)
        function initAudio() {
            try {
                sound.context = new (window.AudioContext || window.webkitAudioContext)();
                sound.gainNode = sound.context.createGain();
                sound.gainNode.connect(sound.context.destination);
            } catch (e) {
                console.warn('Web Audio API is not supported in this browser:', e);
            }
        }

        /**
         * Отображает сообщение об ошибке.
         */
        function showErrorMessage(title, message) {
            errorContainer.style.display = 'flex';
            errorText.innerHTML = `<strong>${title}</strong><br>${message}`;
        }
        
        /**
         * Инициализирует полноэкранный режим.
         * @param {HTMLElement} element - Элемент, который нужно развернуть.
         */
        function requestFullscreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { /* Firefox */
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { /* IE/Edge */
                element.msRequestFullscreen();
            }
        }

        /**
         * Создает 3D-сцену, геометрию и управление.
         */
        function init() {
            // Камера
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 10;
            camera.position.z = 20;
            
            // Сцена
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Небо
            scene.fog = new THREE.Fog(0x87ceeb, 0, forestSize * 0.8);
            
            // Рендерер
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            // Управление
            controls = new THREE.PointerLockControls(camera, document.body);
            scene.add(controls.getObject());
            
            // Слушатели управления
            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);
            
            // Луч для проверки столкновений
            raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0), 0, 1.5);
            
            // --- Создание ландшафта ---
            
            // Свет
            const light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
            light.position.set(0.5, 1, 0.75);
            scene.add(light);
            
            const directionalLight = new THREE.DirectionalLight(0xffddaa, 0.5);
            directionalLight.position.set(20, 50, 20);
            scene.add(directionalLight);
            
            // Пол (Трава)
            const floorGeometry = new THREE.PlaneGeometry(forestSize, forestSize, 1, 1);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x55aa55 }); // Зеленая трава
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = floorHeight;
            scene.add(floor);
            collisionObjects.push(floor);
            
            // Деревья
            createForest();
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', onWindowResize, false);
        }
        
        /**
         * Создает леса с рандомными деревьями.
         */
        function createForest() {
            const treeGeometry = new THREE.CylinderGeometry(0.5, 0.5, 10, 8);
            const treeMaterial = new THREE.MeshLambertMaterial({ color: 0x654321 }); // Коричневый ствол
            const crownGeometry = new THREE.ConeGeometry(3, 8, 8);
            const crownMaterial = new THREE.MeshLambertMaterial({ color: 0x38761d }); // Темно-зеленая крона
            
            for (let i = 0; i < treeCount; i++) {
                // Ствол
                const trunk = new THREE.Mesh(treeGeometry, treeMaterial);
                trunk.position.x = (Math.random() - 0.5) * (forestSize * 0.8);
                trunk.position.z = (Math.random() - 0.5) * (forestSize * 0.8);
                trunk.position.y = floorHeight + 5;
                scene.add(trunk);
                collisionObjects.push(trunk);
                
                // Крона
                const crown = new THREE.Mesh(crownGeometry, crownMaterial);
                crown.position.copy(trunk.position);
                crown.position.y = floorHeight + 10;
                scene.add(crown);
            }
        }
        
        /**
         * Обрабатывает изменение размера окна.
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * Обновляет позицию тегов с именами других игроков.
         */
        function updatePlayerTags() {
            const tagsContainer = document.getElementById('tags-container');
            const halfHeight = window.innerHeight / 2;
            const halfWidth = window.innerWidth / 2;

            for (const id in otherPlayers) {
                const player = otherPlayers[id];
                if (player.tag) {
                    const tagElement = player.tag.element;
                    const vector = player.position.clone();
                    
                    // Проекция 3D позиции на 2D экран
                    vector.project(camera); 

                    // Проверка, находится ли объект перед камерой
                    if (vector.z > 1) { 
                        tagElement.style.display = 'none';
                    } else {
                        tagElement.style.display = 'block';
                        
                        // Перевод нормализованных координат [-1, 1] в пиксели
                        tagElement.style.left = `${(vector.x * halfWidth) + halfWidth - (tagElement.offsetWidth / 2)}px`;
                        tagElement.style.top = `${(-vector.y * halfHeight) + halfHeight - 40}px`; // -40 для смещения над головой
                    }
                }
            }
        }
        
        // --- Игровой цикл ---
        
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            
            if (controls.isLocked === true) {
                // --- Логика движения ---
                
                raycaster.ray.origin.copy(controls.getObject().position);
                raycaster.ray.origin.y -= 1; // Уменьшаем Y для луча
                
                const intersections = raycaster.intersectObjects(collisionObjects, true);
                const onObject = intersections.length > 0;
                
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                
                velocity.y -= 9.8 * 10.0 * delta; // Гравитация
                
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // Гарантируем, что диагональное движение не быстрее
                
                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;
                
                if (onObject === true) {
                    velocity.y = Math.max(0, velocity.y);
                    canJump = true;
                }
                
                controls.getObject().translateX(velocity.x * delta);
                controls.getObject().translateY(velocity.y * delta);
                controls.getObject().translateZ(velocity.z * delta);
                
                if (controls.getObject().position.y < 10) {
                    velocity.y = 0;
                    controls.getObject().position.y = 10; // Фиксируем высоту
                    canJump = true;
                }

                // --- Обновление Firebase ---
                if (multiplayerReady.value) {
                    // Частота обновления позиции (каждые 100мс)
                    if (clock.getElapsedTime() % 0.1 < delta) { 
                        setPlayerPosition(controls.getObject().position, camera.rotation.y);
                    }
                    updatePlayerTags();
                }
            }
            
            renderer.render(scene, camera);
        }
        
        // --- Обработчики событий ---
        
        function onKeyDown(event) {
            switch (event.keyCode) {
                case 38: // UP
                case 87: // W
                    moveForward = true;
                    break;
                case 37: // LEFT
                case 65: // A
                    moveLeft = true;
                    break;
                case 40: // DOWN
                case 83: // S
                    moveBackward = true;
                    break;
                case 39: // RIGHT
                case 68: // D
                    moveRight = true;
                    break;
                case 32: // SPACE
                    if (canJump === true) velocity.y += 200;
                    canJump = false;
                    break;
            }
        }
        
        function onKeyUp(event) {
            switch (event.keyCode) {
                case 38: // UP
                case 87: // W
                    moveForward = false;
                    break;
                case 37: // LEFT
                case 65: // A
                    moveLeft = false;
                    break;
                case 40: // DOWN
                case 83: // S
                    moveBackward = false;
                    break;
                case 39: // RIGHT
                case 68: // D
                    moveRight = false;
                    break;
            }
        }

        /**
         * Запускает игру после нажатия на стартовый экран.
         */
        async function startGame() {
            // 1. Убрать стартовый экран
            startScreen.style.display = 'none';
            
            // 2. Инициализировать аудио (для обхода блокировки мобильных браузеров)
            if (sound.context && sound.context.state === 'suspended') {
                await sound.context.resume();
            }
            
            // 3. Запросить полный экран (для мобильных устройств)
            requestFullscreen(document.documentElement);
            
            // 4. Заблокировать курсор (для управления на ПК)
            controls.lock();

            // 5. Запуск многопользовательского режима
            const success = await setupFirebase();
            if (success) {
                startMultiplayer();
                // Игра уже запущена через window.onload, но теперь она может обновлять позиции.
            }
        }
        
        // --- Основная точка входа ---
        
        window.onload = function() {
            init(); // Инициализация 3D сцены
            initAudio(); // Инициализация аудио (создание контекста)
            
            // Привязка обработчика для старта (поддерживает и клик, и тач)
            startScreen.addEventListener('click', startGame, { once: true });
            startScreen.addEventListener('touchstart', startGame, { once: true });
            
            animate(); // Запуск игрового цикла (он будет ждать controls.isLocked)
        };
        
    </script>
    <style>
        /* Стили для полного экрана и адаптивного дизайна */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #000;
            width: 100vw; /* Важно для мобильных устройств */
            height: 100vh; /* Важно для мобильных устройств */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* Стили для стартового экрана */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            z-index: 1000;
        }
        #startScreen h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        #startScreen p {
            font-size: 1.2rem;
            margin-top: 0;
            color: #ccc;
        }
        
        /* Стили для контейнера ошибок */
        #error-container {
            display: none; /* Скрыто по умолчанию */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: #f00;
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            z-index: 1001;
        }

        /* Контейнер для тегов пользователей */
        #tags-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Позволяет кликам проходить сквозь теги */
            z-index: 999;
        }

        /* Стиль для тега (никнейма) игрока */
        .username-tag {
            position: absolute;
            padding: 2px 5px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            transform: translate(-50%, -50%); /* Центрирование */
        }
    </style>
</head>
<body>
    
    <div id="startScreen">
        <h1>Лесное Приключение (3D FPS)</h1>
        <p>Нажмите, чтобы начать и войти в полноэкранный режим</p>
        <p style="font-size: 1rem; color: #aaa;">Управление: WASD + Мышь (перемещение) / Пробел (прыжок)</p>
    </div>

    <div id="error-container">
        <p id="error-text">Произошла неизвестная ошибка.</p>
        <p>Попробуйте перезагрузить страницу.</p>
    </div>

    <div id="tags-container">
        <!-- Теги других игроков будут добавлены сюда -->
    </div>
</body>
</html>
