<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Приложение для Схватки</title>
    <!-- Подключаем Tailwind CSS для стилей -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Устанавливаем шрифт Inter по умолчанию и черный фон для всего тела */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        /* Анимация вращающегося лоадера */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border-top-color: #f87171; /* Красный цвет для спиннера */
            animation: spin 1s linear infinite;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-red': '#dc2626', /* Интенсивный красный */
                        'custom-red-hover': '#b91c1c',
                    }
                }
            }
        }
    </script>
</head>
<body>

    <!-- 1. Экран Загрузки (Loading Screen) -->
    <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-1000 bg-black z-20">
        <!-- Спиннер -->
        <div class="spinner w-12 h-12 border-4 border-gray-700 rounded-full"></div>
        <p class="mt-4 text-xl text-gray-400" id="loading-message">
            Проверяем кэш...
        </p>
        <p class="mt-2 text-sm text-gray-500">
            (Настоящая загрузка файлов симулируется задержкой)
        </p>
    </div>

    <!-- 2. Основной Экран (Main Screen) -->
    <div id="main-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-1000 bg-black z-10">
        <h1 class="text-4xl sm:text-6xl font-extrabold mb-8 text-gray-100">ПОЛЕ БИТВЫ</h1>
        <p class="text-xl text-gray-400 mb-12">
            Вы готовы к схватке?
        </p>
        <!-- Красная Кнопка -->
        <button id="start-button" class="px-12 py-4 text-xl font-bold rounded-xl shadow-lg transition duration-300 ease-in-out bg-custom-red hover:bg-custom-red-hover active:bg-red-700 transform hover:scale-105">
            НАЧАТЬ СХВАТКУ
        </button>
    </div>
    
    <!-- 3. Экран Видео (Video Screen) -->
    <div id="video-screen" class="hidden absolute inset-0 bg-black flex items-center justify-center z-10">
        <!-- Контейнер, заполняющий весь экран и содержащий видео и визуализатор -->
        <div class="relative w-full h-full">
            <!-- Видео на заднем плане, растянуто на весь экран -->
            <!-- object-cover обеспечивает полноэкранное отображение вертикального видео -->
            <video id="battle-video" class="w-full h-full object-cover absolute top-0 left-0" autoplay crossorigin="anonymous" muted></video>
            
            <!-- Визуализатор поверх видео, прикреплен к нижней части -->
            <canvas id="visualizer-canvas" class="absolute bottom-0 left-0 w-full h-24 z-20"></canvas>
            
            <!-- Индикатор загрузки видео (поверх) -->
            <div id="video-loading" class="absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center hidden z-30">
                <div class="spinner w-16 h-16 border-8 border-gray-600 rounded-full"></div>
                <p class="mt-4 text-xl text-gray-300">Загрузка видео...</p>
            </div>
        </div>
    </div>


    <!-- Кастомное Модальное Сообщение (вместо alert) -->
    <div id="message-box" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm text-center">
            <p class="text-white text-lg mb-4" id="box-message"></p>
            <button onclick="document.getElementById('message-box').classList.add('hidden')" class="bg-custom-red text-white px-4 py-2 rounded-lg hover:bg-custom-red-hover">Закрыть</button>
        </div>
    </div>


    <script type="text/javascript">
        // Инициализация элементов
        const loadingScreen = document.getElementById('loading-screen');
        const mainScreen = document.getElementById('main-screen');
        const videoScreen = document.getElementById('video-screen');
        const battleVideo = document.getElementById('battle-video');
        const visualizerCanvas = document.getElementById('visualizer-canvas');
        const canvasCtx = visualizerCanvas.getContext('2d');
        const loadingMessage = document.getElementById('loading-message');
        const startButton = document.getElementById('start-button');
        const messageBox = document.getElementById('message-box');
        const boxMessage = document.getElementById('box-message');
        const videoLoading = document.getElementById('video-loading'); // Новый элемент для индикации загрузки видео

        // Ключ для кэша в localStorage
        const CACHE_KEY = 'appCacheLoaded';
        
        // =================================================================
        // ВАШ СПИСОК ВИДЕО
        // =================================================================
        const VIDEO_LIST = [
            'https://files.catbox.moe/y09yxd.mp4', // Видео 1
            // Добавьте больше видео по необходимости: 'ваш_url_видео_2.mp4',
        ];
        let currentVideoIndex = 0;
        
        // =================================================================
        // НАСТРОЙКИ АУДИО ВИЗУАЛИЗАТОРА
        // =================================================================
        let audioCtx = null;
        let analyser = null;
        let source = null;
        let dataArray = null;
        let bufferLength = 0;
        let animationFrameId = null;

        /**
         * Инициализирует Web Audio API. Должен быть вызван после взаимодействия с пользователем.
         */
        function initAudioContext() {
            // Если контекст уже создан, выходим
            if (audioCtx) return; 

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; 
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // Подключаем видео элемент к аудио контексту
                source = audioCtx.createMediaElementSource(battleVideo);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                
                // Устанавливаем unmute, так как браузеры могут блокировать autoplay со звуком
                battleVideo.muted = false;

                console.log("AudioContext успешно инициализирован.");
            } catch (e) {
                console.error("Ошибка инициализации AudioContext:", e);
                // Отключаем визуализатор, если аудио не работает
                visualizerCanvas.style.display = 'none'; 
                showMessage("Ошибка инициализации аудио для визуализатора. Проверьте, что видеофайл доступен по CORS.");
            }
        }

        /**
         * Отрисовывает визуализатор частот на холсте.
         */
        function drawVisualizer() {
            animationFrameId = requestAnimationFrame(drawVisualizer);

            if (!analyser) return;

            // Получаем данные частот
            analyser.getByteFrequencyData(dataArray);

            // Очищаем холст (полупрозрачный черный фон поверх видео)
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.6)'; 
            canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            const barWidth = (visualizerCanvas.width / bufferLength) * 2; 
            let x = 0;
            const heightMultiplier = 0.95; // Максимальная высота столбика (95% от канваса)

            for(let i = 0; i < bufferLength; i++) {
                // Высота столбика
                const barHeight = (dataArray[i] / 256) * visualizerCanvas.height * heightMultiplier + 2; 
                
                // Создаем градиент для динамичности (от светлого к темному красному)
                const r = 220; 
                const g = 38;  
                const b = 38;  

                const gradient = canvasCtx.createLinearGradient(0, visualizerCanvas.height, 0, visualizerCanvas.height - barHeight);
                gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.2)`);
                gradient.addColorStop(0.5, `rgba(${r}, ${g}, ${b}, 0.7)`);
                gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 1.0)`);
                
                canvasCtx.fillStyle = gradient;

                // Рисуем столбик с небольшим зазором
                canvasCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth - 1, barHeight); 

                x += barWidth;
            }
        }

        /**
         * Устанавливает размеры холста в соответствии с его контейнером.
         */
        function resizeCanvas() {
            // Размеры холста должны соответствовать его CSS-размерам
            const container = visualizerCanvas.parentElement;
            if (container) {
                visualizerCanvas.width = container.clientWidth;
                visualizerCanvas.height = 96; // Фиксированная высота 96px (h-24)
            }
            
            // Если анимация идет, перерисовываем
            if (animationFrameId) {
                drawVisualizer(); 
            }
        }

        /**
         * Отображает кастомное модальное сообщение (вместо alert()).
         * @param {string} message Сообщение для отображения.
         */
        function showMessage(message) {
            boxMessage.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Симулирует загрузку ресурсов.
         */
        function simulateLoad() {
            const isFirstLoad = localStorage.getItem(CACHE_KEY) === null;
            let loadTime;
            let messageText;

            if (isFirstLoad) {
                loadTime = 3000;
                messageText = 'Кэш не найден. Первая загрузка будет долгой. Сохраняем файлы...';
                
                setTimeout(() => {
                    localStorage.setItem(CACHE_KEY, 'true');
                }, loadTime);

            } else {
                loadTime = 500;
                messageText = 'Кэш найден! Загрузка займет всего полсекунды.';
            }

            loadingMessage.textContent = messageText;

            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                    mainScreen.style.opacity = '1'; 
                }, 1000);

            }, loadTime);
        }
        
        /**
         * Воспроизводит видео по заданному индексу.
         * @param {number} index Индекс видео в массиве VIDEO_LIST.
         */
        function playVideo(index) {
            if (index >= VIDEO_LIST.length) {
                showMessage("Схватка окончена! Все видео были показаны.");
                currentVideoIndex = 0; 
                
                // Остановка визуализатора
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                
                videoScreen.classList.add('hidden');
                mainScreen.classList.remove('hidden');
                return;
            }

            currentVideoIndex = index;
            battleVideo.src = VIDEO_LIST[currentVideoIndex];
            videoLoading.classList.remove('hidden'); // Показываем индикатор загрузки видео
            
            // Принудительная загрузка видео
            battleVideo.load();
            
            battleVideo.play().then(() => {
                videoLoading.classList.add('hidden'); // Скрываем индикатор после начала воспроизведения
                
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
                if (!animationFrameId && analyser) {
                    drawVisualizer(); 
                }
            }).catch(e => {
                videoLoading.classList.add('hidden'); // Скрываем индикатор при ошибке
                console.error(`Ошибка при воспроизведении видео №${index + 1} (${VIDEO_LIST[currentVideoIndex]}):`, e);
                // Пропускаем проблемное видео и переходим к следующему
                showMessage(`Ошибка загрузки видео №${index + 1}. Переход к следующему.`);
                playVideo(currentVideoIndex + 1);
            });
        }
        
        /**
         * Запускает последовательное воспроизведение видео.
         */
        function startBattle() {
            // Инициализация AudioContext и размеров Canvas должна произойти после клика пользователя
            initAudioContext();
            resizeCanvas(); 
            
            mainScreen.classList.add('hidden');
            videoScreen.classList.remove('hidden');
            
            currentVideoIndex = 0; 
            playVideo(currentVideoIndex);
        }


        // =================================================================
        // СЛУШАТЕЛИ СОБЫТИЙ
        // =================================================================

        // Запуск симуляции загрузки при старте
        window.onload = simulateLoad;

        // Обработчик кнопки "Начать схватку"
        startButton.addEventListener('click', startBattle);
        
        // Обработчик для автоматического переключения видео, когда текущее заканчивается
        battleVideo.addEventListener('ended', () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            playVideo(currentVideoIndex + 1);
        });
        
        // Остановка визуализатора при паузе
        battleVideo.addEventListener('pause', () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        });
        
        // Запуск визуализатора при возобновлении воспроизведения
        battleVideo.addEventListener('play', () => {
            if (!animationFrameId && analyser) {
                drawVisualizer();
            }
        });
        
        // Слушатель для изменения размера окна (для адаптивности визуализатора)
        window.addEventListener('resize', resizeCanvas);
        
        // Повторный вызов resizeCanvas, чтобы убедиться, что он работает корректно
        window.setTimeout(resizeCanvas, 100);

    </script>

</body>
</html>